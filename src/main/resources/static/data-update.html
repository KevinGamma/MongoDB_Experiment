<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据更新与批量编辑</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI", "Nunito", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: radial-gradient(circle at 15% 20%, #fef3c7, #fff7ed 32%, #eef2ff 70%);
            color: #0f172a;
            margin: 0;
            padding: 0;
        }
        header {
            padding: 26px 24px 22px;
            background: linear-gradient(120deg, #0ea5e9, #22c55e);
            color: #ffffff;
            box-shadow: 0 16px 36px rgba(0, 0, 0, 0.14);
        }
        h1 {
            margin: 0 0 6px;
            font-size: 30px;
            font-weight: 800;
        }
        p.subtitle {
            margin: 0;
            opacity: 0.9;
        }
        .container {
            max-width: 1180px;
            margin: 24px auto 60px;
            padding: 0 16px;
        }
        .nav-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            background: linear-gradient(120deg, #0ea5e9, #22c55e);
            color: #ffffff;
            padding: 14px 16px;
            border-radius: 16px;
            box-shadow: 0 14px 32px rgba(14, 165, 233, 0.18);
            margin-bottom: 14px;
        }
        .nav-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav-card button,
        .pill-btn {
            border: none;
            background: #ffffff;
            color: #0f172a;
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
            box-shadow: 0 10px 22px rgba(15, 23, 42, 0.18);
        }
        .nav-card button:hover,
        .pill-btn:hover {
            transform: translateY(-2px);
            background: #f8fafc;
        }
        .panel {
            background: #ffffff;
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 14px 34px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        .tabs button {
            border: none;
            padding: 10px 14px;
            border-radius: 12px;
            background: #e2e8f0;
            color: #0f172a;
            cursor: pointer;
            font-weight: 700;
            transition: background 0.12s ease, transform 0.1s ease;
        }
        .tabs button.active {
            background: linear-gradient(120deg, #0ea5e9, #22c55e);
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(14, 165, 233, 0.22);
        }
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .filters label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-weight: 600;
            color: #0f172a;
        }
        .filters input {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            outline: none;
            transition: border-color 0.12s ease, box-shadow 0.12s ease;
        }
        .filters input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.16);
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }
        .btn {
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: background 0.12s ease, transform 0.1s ease, box-shadow 0.12s ease;
        }
        .btn.primary {
            background: #0ea5e9;
            color: #ffffff;
            box-shadow: 0 8px 16px rgba(14, 165, 233, 0.24);
        }
        .btn.primary:hover {
            background: #0284c7;
            transform: translateY(-1px);
        }
        .btn.secondary {
            background: #e2e8f0;
            color: #0f172a;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin: 12px 0 10px;
        }
        select {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            font-weight: 700;
            color: #0f172a;
        }
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 12px;
            font-weight: 700;
        }
        .status.success {
            background: rgba(34, 197, 94, 0.16);
            color: #14532d;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .status.error {
            background: rgba(239, 68, 68, 0.16);
            color: #7f1d1d;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
            font-size: 14px;
        }
        th {
            background: #f8fafc;
            font-weight: 800;
            color: #0f172a;
        }
        tr:last-child td {
            border-bottom: none;
        }
        td input {
            width: 100%;
            box-sizing: border-box;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        td input:focus {
            border-color: #22c55e;
            outline: none;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.16);
        }
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        .empty {
            padding: 14px 12px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px dashed #cbd5e1;
            color: #475569;
            text-align: center;
        }
        @media (max-width: 720px) {
            h1 { font-size: 24px; }
            th, td { font-size: 13px; }
        }
    </style>
</head>
<body>
<header>
    <h1>数据更新与批量编辑</h1>
    <p class="subtitle">针对 students / teachers / courses 的过滤、单条更新、批量更新</p>
</header>

<div id="app" class="container">
    <div class="nav-card">
        <div>
            <strong>操作提示</strong>
            <span style="margin-left:8px;opacity:0.85;">先过滤后再在表格中直接修改，支持勾选多行批量保存。</span>
        </div>
        <div class="nav-actions">
            <button onclick="location.href='index.html'">返回主页</button>
        </div>
    </div>

    <section class="panel" v-cloak>
        <div class="tabs">
            <button
                    v-for="dataset in datasets"
                    :key="dataset.key"
                    :class="{ active: dataset.key === activeKey }"
                    @click="selectDataset(dataset.key)">
                {{ dataset.label }}
            </button>
        </div>

        <div v-if="activeDataset">
            <div class="filters">
                <label v-for="filter in activeDataset.filters" :key="filter.key">
                    <span>{{ filter.label }}</span>
                    <input
                            :type="filter.type || 'text'"
                            :placeholder="filter.placeholder || ''"
                            v-model="filterValues[activeDataset.key][filter.key]" />
                </label>
            </div>
            <div class="filter-actions">
                <button class="btn primary" :disabled="loading" @click="loadData">过滤并加载</button>
                <button class="btn secondary" :disabled="loading" @click="resetFilters">重置筛选</button>
            </div>

            <div class="toolbar">
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                    <span class="pill-btn" style="background:#e0f2fe;">当前数据 {{ rows.length }} 条</span>
                    <span class="pill-btn" style="background:#dcfce7;">已勾选 {{ selectedIds.length }} 条</span>
                    <button class="btn primary" :disabled="loading || !selectedIds.length" @click="bulkSave">
                        批量保存勾选
                    </button>
                    <button class="btn secondary" :disabled="loading" @click="loadData">刷新</button>
                    <label class="pill-btn" style="display:flex;align-items:center;gap:8px;background:#f1f5f9;box-shadow:none;">
                        每页
                        <select v-model.number="pageSize" @change="onPageSizeChange">
                            <option v-for="size in pageSizes" :key="size" :value="size">{{ size }}</option>
                        </select>
                    </label>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button class="btn secondary" :disabled="loading || currentPage===1" @click="setPage(currentPage - 1)">上一页</button>
                        <span class="pill-btn" style="background:#e0f2fe;box-shadow:none;">
                            第 {{ currentPage }} / {{ totalPages }} 页
                        </span>
                        <button class="btn secondary" :disabled="loading || currentPage===totalPages" @click="setPage(currentPage + 1)">下一页</button>
                    </div>
                </div>
                <div v-if="status.message" :class="['status', status.type]">
                    {{ status.message }}
                </div>
            </div>

            <div v-if="rows.length" class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th style="width:52px;">
                            <input type="checkbox" :checked="allSelected" @change="toggleSelectAll($event)">
                        </th>
                        <th v-for="column in activeDataset.columns" :key="column.key">{{ column.label }}</th>
                        <th style="width:120px;">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="row in pagedRows" :key="row.id">
                        <td>
                            <input
                                    type="checkbox"
                                    :value="row.id"
                                    v-model="selectedIds" />
                        </td>
                        <td v-for="column in activeDataset.columns" :key="column.key">
                            <input
                                    :type="column.type || 'text'"
                                    v-model="row[column.key]"
                                    :readonly="column.readonly" />
                        </td>
                        <td>
                            <button class="btn primary" style="width:100%;" :disabled="loading" @click="saveRow(row)">
                                保存此行
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div v-else class="empty">尚未加载数据或无匹配结果，请调整筛选条件后点击“过滤并加载”。</div>
        </div>
    </section>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loading: false,
                status: { type: "", message: "" },
                activeKey: "students",
                rows: [],
                selectedIds: [],
                pageSizes: [25, 50, 100],
                pageSize: 25,
                currentPage: 1,
                filterValues: {},
                datasets: [
                    {
                        key: "students",
                        label: "学生",
                        endpoint: "/api/students",
                        numericFields: ["age"],
                        filters: [
                            { key: "sid", label: "学号" },
                            { key: "name", label: "姓名" },
                            { key: "sex", label: "性别" },
                            { key: "minAge", label: "最小年龄", type: "number" },
                            { key: "maxAge", label: "最大年龄", type: "number" },
                            { key: "dname", label: "院系" },
                            { key: "clazz", label: "班级" }
                        ],
                        columns: [
                            { key: "sid", label: "学号" },
                            { key: "name", label: "姓名" },
                            { key: "sex", label: "性别" },
                            { key: "age", label: "年龄", type: "number" },
                            { key: "birthday", label: "生日" },
                            { key: "dname", label: "院系" },
                            { key: "clazz", label: "班级" },
                            { key: "id", label: "文档ID", readonly: true }
                        ]
                    },
                    {
                        key: "teachers",
                        label: "教师",
                        endpoint: "/api/teachers",
                        numericFields: ["age"],
                        filters: [
                            { key: "tid", label: "教师编号" },
                            { key: "name", label: "姓名" },
                            { key: "sex", label: "性别" },
                            { key: "minAge", label: "最小年龄", type: "number" },
                            { key: "maxAge", label: "最大年龄", type: "number" },
                            { key: "dname", label: "院系" }
                        ],
                        columns: [
                            { key: "tid", label: "教师编号" },
                            { key: "name", label: "姓名" },
                            { key: "sex", label: "性别" },
                            { key: "age", label: "年龄", type: "number" },
                            { key: "dname", label: "院系" },
                            { key: "id", label: "文档ID", readonly: true }
                        ]
                    },
                    {
                        key: "courses",
                        label: "课程",
                        endpoint: "/api/courses",
                        numericFields: ["fcid", "credit"],
                        filters: [
                            { key: "cid", label: "课程编号" },
                            { key: "name", label: "课程名称" },
                            { key: "fcid", label: "先行课号", type: "number" },
                            { key: "minCredit", label: "最小学分", type: "number" },
                            { key: "maxCredit", label: "最大课分", type: "number" }
                        ],
                        columns: [
                            { key: "cid", label: "课程编号" },
                            { key: "name", label: "课程名称" },
                            { key: "fcid", label: "先行课号", type: "number" },
                            { key: "credit", label: "学分", type: "number" },
                            { key: "id", label: "文档ID", readonly: true }
                        ]
                    }
                ]
            };
        },
        computed: {
            activeDataset() {
                return this.datasets.find(item => item.key === this.activeKey);
            },
            totalPages() {
                if (!this.rows.length) return 1;
                return Math.max(1, Math.ceil(this.rows.length / this.pageSize));
            },
            pagedRows() {
                const start = (this.currentPage - 1) * this.pageSize;
                return this.rows.slice(start, start + this.pageSize);
            },
            allSelected() {
                const ids = this.pagedRows.map(row => row.id);
                return ids.length > 0 && ids.every(id => this.selectedIds.includes(id));
            }
        },
        mounted() {
            this.datasets.forEach(dataset => {
                this.filterValues[dataset.key] = this.filterValues[dataset.key] || this.buildEmptyFilters(dataset);
            });
            this.loadData();
        },
        methods: {
            buildEmptyFilters(dataset) {
                const filters = {};
                dataset.filters.forEach(filter => filters[filter.key] = "");
                return filters;
            },
            selectDataset(key) {
                this.activeKey = key;
                if (!this.filterValues[key]) {
                    this.filterValues[key] = this.buildEmptyFilters(this.activeDataset);
                }
                this.status = { type: "", message: "" };
                this.rows = [];
                this.selectedIds = [];
                this.loadData();
            },
            resetFilters() {
                if (this.activeDataset) {
                    this.filterValues[this.activeDataset.key] = this.buildEmptyFilters(this.activeDataset);
                }
            },
            normalizeFilterParams(dataset) {
                const filter = this.filterValues[dataset.key] || {};
                const params = {};
                Object.entries(filter).forEach(([key, value]) => {
                    if (value === "" || value === null || value === undefined) return;
                    const filterConfig = dataset.filters.find(item => item.key === key);
                    if (filterConfig && filterConfig.type === "number") {
                        const num = Number(value);
                        if (!Number.isNaN(num)) {
                            params[key] = num;
                        }
                    } else {
                        params[key] = value;
                    }
                });
                return params;
            },
            async loadData() {
                if (!this.activeDataset) return;
                this.loading = true;
                this.status = { type: "", message: "" };
                this.currentPage = 1;
                try {
                    const params = this.normalizeFilterParams(this.activeDataset);
                    const response = await axios.get(`${this.activeDataset.endpoint}/search`, { params });
                    this.rows = (response.data || []).map(item => this.normalizeRow(item, this.activeDataset));
                    this.selectedIds = [];
                } catch (e) {
                    this.setStatus("error", e.response?.data?.message || e.message || "加载失败");
                } finally {
                    this.loading = false;
                }
            },
            applyNumericFields(payload, numericFields = []) {
                numericFields.forEach(field => {
                    const value = payload[field];
                    if (value === "" || value === null || value === undefined) {
                        payload[field] = null;
                        return;
                    }
                    const num = Number(value);
                    if (Number.isNaN(num)) {
                        throw new Error(`字段 ${field} 需要数字`);
                    }
                    payload[field] = num;
                });
            },
            async saveRow(row) {
                if (!this.activeDataset) return;
                if (!row.id) {
                    this.setStatus("error", "缺少文档ID，无法更新");
                    return;
                }
                try {
                    this.loading = true;
                    const payload = { ...row };
                    this.applyNumericFields(payload, this.activeDataset.numericFields);
                    const response = await axios.put(`${this.activeDataset.endpoint}/${row.id}`, payload);
                    Object.assign(row, this.normalizeRow(response.data, this.activeDataset));
                    this.setStatus("success", "已保存 1 条记录");
                } catch (e) {
                    this.setStatus("error", e.response?.data?.message || e.message || "更新失败");
                } finally {
                    this.loading = false;
                }
            },
            async bulkSave() {
                if (!this.activeDataset) return;
                const selectedRows = this.rows.filter(row => this.selectedIds.includes(row.id));
                if (!selectedRows.length) {
                    this.setStatus("error", "请先勾选需要批量保存的行");
                    return;
                }
                try {
                    this.loading = true;
                    const payload = selectedRows.map(row => {
                        const record = { ...row };
                        this.applyNumericFields(record, this.activeDataset.numericFields);
                        return record;
                    });
                    const response = await axios.put(`${this.activeDataset.endpoint}/bulk`, payload);
                    const updatedMap = new Map((response.data || []).map(item => {
                        const normalized = this.normalizeRow(item, this.activeDataset);
                        return [normalized.id, normalized];
                    }));
                    this.rows = this.rows.map(row => updatedMap.get(row.id) || row);
                    this.selectedIds = [];
                    this.setStatus("success", `批量保存成功，共 ${response.data?.length || 0} 条`);
                } catch (e) {
                    this.setStatus("error", e.response?.data?.message || e.message || "批量更新失败");
                } finally {
                    this.loading = false;
                }
            },
            toggleSelectAll(event) {
                const pageIds = this.pagedRows.map(row => row.id);
                if (event.target.checked) {
                    this.selectedIds = Array.from(new Set([...this.selectedIds, ...pageIds]));
                } else {
                    this.selectedIds = this.selectedIds.filter(id => !pageIds.includes(id));
                }
            },
            setPage(page) {
                const target = Math.min(Math.max(page, 1), this.totalPages);
                this.currentPage = target;
            },
            onPageSizeChange() {
                this.setPage(1);
            },
            setStatus(type, message) {
                this.status = { type, message };
                if (type === "success") {
                    setTimeout(() => {
                        if (this.status.type === "success") {
                            this.status = { type: "", message: "" };
                        }
                    }, 2400);
                }
            },
            normalizeRow(item, dataset) {
                const normalized = { ...item };
                if (dataset.key === "students") {
                    normalized.clazz = normalized.clazz ?? normalized.CLASS ?? normalized["class"] ?? "";
                }
                return normalized;
            }
        }
    }).mount("#app");
</script>
</body>
</html>
